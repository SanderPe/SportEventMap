<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Home</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css' rel='stylesheet' />
    <script src="https://kit.fontawesome.com/4c7a5b9ab6.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="../Controller/index.css">


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
<h1>Case Project</h1>

<h5>You need to add a CSV file before you can see the map & filter on categories.</h5>

<br>
<br>

<div id="buttondiv" >
    <input type="file" id="inputfile">
    <input type="button" id="viewfile" value="Import file">

</div>
<br>

        <form id="filtering">
            <label for="cat_a">A-level</label>
            <input type="checkbox" id="cat_a" name="cat_a" value="A-level">

            <label for="cat_b">B-level</label>
            <input type="checkbox" id="cat_b" name="cat_a" value="B-level">

            <label for="cat_c">C-level</label>
            <input type="checkbox" id="cat_c" name="cat_c" value="C-level">

            <label for="cat_d">D-level</label>
            <input type="checkbox" id="cat_d" name="cat_d" value="D-level">

            <label for="cat_e">E-level</label>
            <input type="checkbox" id="cat_e" name="cat_e" value="E-level">
            <br>

            <label for="cat_international">International</label>
            <input type="checkbox" id="cat_international" name="cat_international" value="International">

            <label for="cat_future">Future Series</label>
            <input type="checkbox" id="cat_future" name="cat_future" value="Future">

            <label for="cat_other">Other</label>
            <input type="checkbox" id="cat_other" name="cat_other" value="Other">
            <br>
            <br>

        <input type="submit" value="Confirm">

        </form>

<br>

<div id="map" style="width: 75%; height: 600px"></div>

<script src="../Controller/GeoJSON.js" type="text/javascript">

</script>

<script type="text/javascript">

    var geojson2 = [];

    $(document).ready(function () {

        $('#viewfile').click(function () {

            var file = new FileReader();
            file.onload = function (e) {


                var rows = e.target.result.split("\n");


                for (var row = 0; row < rows.length; row++){
                    var columns = rows[row].split(",");

                    var cells = columns[0].split(";");

                    var country = cells[5];
                    var region = cells[7];
                    var ort = cells[6];
                    var category = cells[10];
                    var link = cells[12];
                    var title = cells[1];

                    geocode();
                    // geocode function

                    function geocode(){
                        var location = ort + " " + country;


                        axios.get('https://api.opencagedata.com/geocode/v1/json', {params:{
                                q:location,
                                key: '5ae703a49d7a4a2e97f38cdbda0f7ec8'
                            }}).then(function (response) {

                                //formatted address
                            var lat = response.data.results[0].geometry.lat;
                            var lng = response.data.results[0].geometry.lng;
                            var category_color = "#64809B";
                            //console.log(lat + " "+ lng)
                            console.log(response);

                            // geojson file construction

                            if (category == "A-Level"){
                                category_color = "#FF0000";
                            }
                            else if (category == "B-Level"){
                                category_color = "#FFFF00";
                            }
                            else if (category == "C-Level"){
                                category_color = "#36FF00";
                            }
                            else if (category == "D-Level"){
                                category_color = "#00FFF0";
                            }
                            else if (category == "E-Level"){
                                category_color = "#C100FF";
                            }


                            var address = {
                                "type": "Feature",
                                "geometry": {
                                    "type": "Point",
                                    "coordinates": [lat , lng]
                                },
                                "properties": {
                                    "title": title,
                                    "description": link,

                                    "marker-color": category_color,
                                    "marker-size": "medium",
                                    "marker-symbol": "soccer"
                                }
                            };


                            geojson2.push(address);


                        })
                            .catch(function (error) {
                                console.log(error)
                            });
                    }

                    //console.log(country,ort,region);


                }

                //map construction
                mapboxgl.accessToken = 'pk.eyJ1Ijoic2FuZGVyNzg5IiwiYSI6ImNrZzFhZzl3cTBmZ3gyenBpZ3Jqb2dseXAifQ.XoRNw5LemXXJwFvbV7Dubg';
                var map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/streets-v11',
                    center: [10.451526 ,51.165691], // starting position [lng, lat]
                    zoom: 6


                });
                //add constructed geojson2 list to map

                map.on('load', function () {

                    map.loadImage(
                        'https://docs.mapbox.com/mapbox-gl-js/assets/custom_marker.png',
                        function (error, image) {
                            if (error) throw error;
                            map.addImage('custom-marker', image);

                            map.addSource('points', {
                                'type': 'geojson',
                                'data': {
                                    'type': 'FeatureCollection',
                                    'features':  geojson2
                                }
                            });

                            map.addLayer({
                                'id': 'points',
                                'type': 'symbol',
                                'source': 'points',
                                'layout': {
                                    'icon-image': 'custom-marker',
// get the title name from the source's "title" property
                                    'text-field': ['get', 'title'],
                                    'text-font': [
                                        'Open Sans Semibold',
                                        'Arial Unicode MS Bold'
                                    ],
                                    'text-offset': [0, 1.25],
                                    'text-anchor': 'top'
                                }
                            });
                        })})

                   // console.log(geojson2)



            };
            file.readAsText($("#inputfile")[0].files[0]);
        })

    })
</script>



</body>
</html>